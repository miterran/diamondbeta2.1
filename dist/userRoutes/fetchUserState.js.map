{"version":3,"sources":["../../src/userRoutes/fetchUserState.js"],"names":["OpenBet","HistoryBet","router","Router","get","req","res","thisWeekBalance","openBetTotalRiskAmount","openBetTotalWinAmount","openBetStraight","openBetParlay","totalGamePending","find","user","username","createdAt","$gte","startOf","$lte","endOf","thisWeekHistoryBets","console","log","isEmpty","map","historyBet","Number","orderResultAmount","openBets","openBet","betOption","eventsWagerDetail","RiskAmount","WinAmount","findOne","err","result","userState","accountType","accountActive","thisWeekExtraCredit","weeklyStartBalance","maxWinAmount","maxWagerAmount","minRiskAmount","passcode","currentBalance","pendingCredit","maxParlayTeam","availableCredit","json"],"mappings":"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","file":"fetchUserState.js","sourcesContent":["import _ from 'lodash';\nimport moment from 'moment';\nimport User from '../models/User';\nimport express from 'express';\nimport BetOrder from '../models/BetOrder'\nconst OpenBet = BetOrder.OpenBet\nconst HistoryBet = BetOrder.HistoryBet\nconst router = express.Router();\n\nrouter.get('/fetch-user-state', async (req, res) => {\n\n\tlet thisWeekBalance = 0\n\tlet openBetTotalRiskAmount = 0\n\tlet openBetTotalWinAmount = 0\n\n    let openBetStraight = 0\n    let openBetParlay = 0\n    let totalGamePending = 0\n\n\tconst thisWeekHistoryBets = await HistoryBet.find({user: req.user.username, createdAt: {$gte: moment().startOf('week'), $lte: moment().endOf('week')}})\n\tconsole.log('get user state history')\n\tif(!_.isEmpty(thisWeekHistoryBets)){\n\t\tthisWeekHistoryBets.map(function(historyBet){\n\t\t\tthisWeekBalance += Number(historyBet.orderResultAmount);\n\t\t})\n\t}\n\n\tconst openBets = await OpenBet.find({user: req.user.username})\n\tconsole.log('get user state openbet')\n\tif(!_.isEmpty(openBets)){\n\t   \topenBets.map(function(openBet){\n\t\t\tif(openBet.betOption === 'Straight'){\n\t\t\t\topenBetStraight++\n\t\t\t}\n\t\t\tif(openBet.betOption === 'Parlay'){\n\t\t\t\topenBetParlay++\n\t\t\t}\n\t\t\ttotalGamePending++\n\t   \t\topenBetTotalRiskAmount += Number(openBet.eventsWagerDetail.RiskAmount);\n\t   \t\topenBetTotalWinAmount += Number(openBet.eventsWagerDetail.WinAmount);\n\t   \t})\n\t}\n\n\tUser.findOne({username: req.user.username}, 'accountType username accountActive thisWeekExtraCredit weeklyStartBalance maxWinAmount maxWagerAmount minRiskAmount passcode maxParlayTeam', function(err, result){\n\t\tconsole.log('send all')\n\t\tconst userState = {\n\t\t\taccountType: result.accountType,\n\t\t\tusername: result.username,\n\t\t\taccountActive: result.accountActive,\n\t\t\tthisWeekExtraCredit: result.thisWeekExtraCredit,\n\t\t\tweeklyStartBalance: result.weeklyStartBalance,\n\t\t\tmaxWinAmount: result.maxWinAmount,\n\t\t\tmaxWagerAmount: result.maxWagerAmount,\n\t\t\tminRiskAmount: result.minRiskAmount,\n\t\t\tpasscode: result.passcode,\n\t\t\tcurrentBalance: thisWeekBalance,\n\t\t\tpendingCredit: openBetTotalRiskAmount,\n\t\t\tmaxParlayTeam: result.maxParlayTeam,\n\t\t\tavailableCredit: Number(result.weeklyStartBalance) + Number(result.thisWeekExtraCredit) + Number(thisWeekBalance) - Number(openBetTotalRiskAmount),\n\t\t\topenBetStraight: openBetStraight,\n\t\t\topenBetParlay: openBetParlay,\n\t\t\ttotalGamePending: totalGamePending,\n\t\t\topenBetTotalRiskAmount: openBetTotalRiskAmount,\n\t\t\topenBetTotalWinAmount: openBetTotalWinAmount\n\n\t\t}\n\t\tres.json(userState)\n\t})\n})\n\nexport default router;"]}