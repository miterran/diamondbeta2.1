{"version":3,"sources":["../../src/schedule/openBetResult.js"],"names":["OpenBet","find","openBets","isEmpty","Promise","all","map","openBet","eventsHaveWon","events","event","Status","eventsHaveLost","eventsHavePush","eventsHaveCanceled","eventsHavePostponed","eventsHaveReview","allEventsWon","every","allEventsLost","allEventsPush","allEventsCanceled","allEventsPostponed","allEventsReview","allEventsFinished","Result","Final","resultBet","orderNumber","betOption","superAgent","agent","user","eventsWagerDetail","orderStatus","createdAt","completedAt","orderResultAmount","WinAmount","Number","RiskAmount","toFixed","parlayPoint","BetDetail","OddLine","push","Math","abs","riskPoint","reduce","a","b","newHistoryBet","HistoryBet","save","findOneAndRemove","_id","newReviewBet","ReviewBet","console","log","then","catch","error","openBetResult"],"mappings":"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","file":"openBetResult.js","sourcesContent":["import moment from 'moment';\nimport config from '../config';\nimport BetOrder from '../models/BetOrder'\nconst OpenBet = BetOrder.OpenBet\nconst ReviewBet = BetOrder.ReviewBet\nconst HistoryBet = BetOrder.HistoryBet\nimport _ from 'lodash';\n\nasync function openBetResult (){\n\tconst openBets = await OpenBet.find({});\n\tif(!_.isEmpty(openBets)){\n\t\tawait Promise.all(openBets.map(async function(openBet){\n\n\t\t\tconst eventsHaveWon = _.find(openBet.events, (event) => event.Status === 'Won')\n\t\t\tconst eventsHaveLost = _.find(openBet.events, (event) => event.Status === 'Lost')\n\t\t\tconst eventsHavePush = _.find(openBet.events, (event) => event.Status === 'Push')\n\t\t\tconst eventsHaveCanceled = _.find(openBet.events, (event) => event.Status === 'Canceled')\n\t\t\tconst eventsHavePostponed = _.find(openBet.events, (event) => event.Status === 'Postponed')\n\t\t\tconst eventsHaveReview = _.find(openBet.events, (event) => event.Status === 'Review')\n\n\t\t\tconst allEventsWon = openBet.events.every((event) => event.Status === 'Won' )\n\t\t\tconst allEventsLost = openBet.events.every((event) => event.Status === 'Lost' )\n\t\t\tconst allEventsPush = openBet.events.every((event) => event.Status === 'Push' )\n\t\t\tconst allEventsCanceled = openBet.events.every((event) => event.Status === 'Canceled' )\n\t\t\tconst allEventsPostponed = openBet.events.every((event) => event.Status === 'Postponed' )\n\t\t\tconst allEventsReview = openBet.events.every((event) => event.Status === 'Review' )\n\n\t\t\tconst allEventsFinished = openBet.events.every((event) => event.Result.Final === true )\n\t\t\tif(allEventsFinished){\n\n\t\t\t\tlet resultBet = {\n\t\t    \t\torderNumber: openBet.orderNumber,\n\t\t    \t\tbetOption: openBet.betOption,\n\t\t    \t\tsuperAgent: openBet.superAgent,\n\t\t    \t\tagent: openBet.agent,\n\t\t    \t\tuser: openBet.user,\n\t\t    \t\tevents: openBet.events,\n\t\t    \t\teventsWagerDetail: openBet.eventsWagerDetail,\n\t\t    \t\torderStatus: 'Pending',\n\t\t    \t\tcreatedAt: openBet.createdAt,\n\t\t    \t\tcompletedAt: moment(),\n\t\t    \t\torderResultAmount: 0\n\t\t\t\t}\n\n\t\t\t\tif(openBet.betOption === 'Straight'){\n\t\t\t\t\tswitch(openBet.events[0].Status){\n\t\t\t\t\t\tcase 'Won':\n\t\t\t\t\t\t\tresultBet.orderStatus = 'Won';\n\t\t\t\t\t\t\tresultBet.orderResultAmount = openBet.eventsWagerDetail.WinAmount;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase 'Lost':\n\t\t\t\t\t\t\tresultBet.orderStatus = 'Lost';\n\t\t\t\t\t\t\tresultBet.orderResultAmount = -Number(openBet.eventsWagerDetail.RiskAmount);\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase 'WonHalf':\n\t\t\t\t\t\t\tresultBet.orderStatus = 'WonHalf';\n\t\t\t\t\t\t\tresultBet.orderResultAmount = (Number(openBet.eventsWagerDetail.WinAmount) / 2).toFixed();\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase 'LostHalf':\n\t\t\t\t\t\t\tresultBet.orderStatus = 'LostHalf';\n\t\t\t\t\t\t\tresultBet.orderResultAmount = -(Number(openBet.eventsWagerDetail.RiskAmount) / 2).toFixed();\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase 'Push':\n\t\t\t\t\t\t\tresultBet.orderStatus = 'Push';\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase 'Postponed':\n\t\t\t\t\t\t\tresultBet.orderStatus = 'Postponed';\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase 'Canceled':\n\t\t\t\t\t\t\tresultBet.orderStatus = 'Canceled';\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\tresultBet.orderStatus = 'Review';\n\t\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif(openBet.betOption === 'Parlay'){\n\t\t\t\t\tswitch(true){\n\t\t\t\t\t\tcase allEventsPush:\n\t\t\t\t\t\t\tresultBet.orderStatus = 'Push'\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase allEventsCanceled:\n\t\t\t\t\t\t\tresultBet.orderStatus = 'Canceled'\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase !_.isEmpty(eventsHaveWon) &&  _.isEmpty(eventsHaveReview) && _.isEmpty(eventsHaveLost) && _.isEmpty(eventsHavePostponed) || allEventsWon:\n\t\t\t\t\t\t\tlet parlayPoint = []\n\t\t\t\t\t\t\topenBet.events.map(event => {\n\t\t\t\t\t\t\t\tif(event.Status === 'Won'){\n\t\t\t\t\t\t\t\t\tif(event.BetDetail.OddLine > 0){ \n\t\t\t\t\t\t\t\t\t\tparlayPoint.push((Number(event.BetDetail.OddLine) + 100) / 100)\n\t\t\t\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\t\t\tparlayPoint.push((Math.abs(event.BetDetail.OddLine) + 100) / Math.abs(event.BetDetail.OddLine))\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\tlet riskPoint = parlayPoint.reduce((a, b) =>  a * b )\n\t\t\t\t\t\t\tresultBet.orderStatus = 'Won';\n\t\t\t\t\t\t\tresultBet.orderResultAmount = ((Number(openBet.eventsWagerDetail.RiskAmount) * Number(riskPoint) - Number(openBet.eventsWagerDetail.RiskAmount)) * 1).toFixed()\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase !_.isEmpty(eventsHaveLost):\n\t\t\t\t\t\t\tresultBet.orderStatus = 'Lost'\n\t\t\t\t\t\t\tresultBet.orderResultAmount = -Number(openBet.eventsWagerDetail.RiskAmount);\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase !_.isEmpty(eventsHavePostponed):\n\t\t\t\t\t\t\tresultBet.orderStatus = 'Postponed'\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\tresultBet.orderStatus = 'Review'\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif(resultBet.orderStatus !== 'Pending'){\n\t\t\t\t\tif(resultBet.orderStatus !== 'Review' || resultBet.orderStatus !== 'Postponed'){\n\t\t\t\t\t\tlet newHistoryBet = new HistoryBet(resultBet)\n\t\t\t\t\t\tawait newHistoryBet.save()\n\t\t\t\t\t\tawait OpenBet.findOneAndRemove({ _id: openBet._id})\n\t\t\t\t\t}else{\n\t\t\t\t\t\tlet newReviewBet = new ReviewBet(resultBet)\n\t\t\t\t\t\tawait newReviewBet.save()\n\t\t\t\t\t\tawait OpenBet.findOneAndRemove({ _id: openBet._id})\n\t\t\t\t\t}\n\t\t\t\t}else{\n\t\t\t\t\tconsole.log('open bet result calculate has error')\n\t\t\t\t}\n\t\t\t}\n\n\t\t})).then(() => {\n\t\t\tconsole.log('open bet result done')\n\t\t}).catch((error) => {\n\t\t\tconsole.log('open bet result error')\n\t\t\tthrow error\n\t\t})\n\t}else{\n\t\tconsole.log('openBet is empty')\n\t}\n}\n\nexport default openBetResult"]}